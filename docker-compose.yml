
services:

  articles_database:
    image: pgvector/pgvector:pg16
    restart: always
    environment:
      - POSTGRES_USER=${ARTICLES_DB_USER}
      - POSTGRES_PASSWORD=${ARTICLES_DB_PASSWORD}
      - POSTGRES_DB=${ARTICLES_DB_NAME}
    volumes:
      - ./data/articles_db/data:/var/lib/postgresql/data
    ports:
      - "${ARTICLES_DB_PORT}:5432"
    networks:
      - app_network
    depends_on:
      - prefect_server

  entity_service:
    build: 
      context: ./SSARE
      dockerfile: ./entity_service/Dockerfile
    restart: always
    ports:
      - "${ENTITY_SERVICE_PORT}:1290"
    networks:
      - app_network
    depends_on:
      - redis
      - postgres_service
      - prefect_server
    environment:
      - PREFECT_API_URL=http://prefect_server:${PREFECT_SERVER_PORT}/api
    develop:
      watch:
        - path: ./SSARE/entity_service
          target: /app
          action: sync

  geo_service:
    build: 
      context: ./SSARE
      dockerfile: ./geo_service/Dockerfile
    restart: always
    ports:
      - "${GEO_SERVICE_PORT}:3690"
    expose:
      - "3690"
    networks:
      - app_network
      - default
    depends_on:
      - redis
      - postgres_service
      - pelias_placeholder
      - prefect_server
    environment:
      - PREFECT_API_URL=http://prefect_server:${PREFECT_SERVER_PORT}/api
    develop:
      watch:
        - path: ./SSARE/geo_service
          target: /app
          action: sync

  main_core_app:
    build: 
      context: ./SSARE
      dockerfile: ./app/Dockerfile
    develop:
      watch:
        - path: ./SSARE/app
          target: /app
          action: sync
        - path: ./SSARE/flows
          target: /app/flows
          action: sync
        - path: ./SSARE/core
          target: /app/core
          action: sync
    ports:
      - "${MAIN_CORE_APP_PORT}:8089"
    networks:
      - app_network
    environment:
      - PREFECT_API_URL=http://prefect_server:${PREFECT_SERVER_PORT}/api
      - R2R_API_URL=http://r2r:${R2R_PORT}
    depends_on:
      - scraper_service
      - postgres_service
      - redis
      - prefect_server

  neo4j:
    container_name: neo4j
    image: neo4j:latest
    ports:
      - "${NEO4J_HTTP_PORT}:7474"
      - "${NEO4J_BOLT_PORT}:7687"
    environment:
      - NEO4J_AUTH=neo4j/'king kong'
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DB}
    volumes:
      - ./data/neo4j_db/data:/data
      - ./data/neo4j_db/logs:/logs
      - ./data/neo4j_db/import:/var/lib/neo4j/import
      - ./data/neo4j_db/plugins:/plugins
    networks:
      - app_network
      - default
    depends_on:
      - prefect_server

  nlp_service:
    build: 
      context: ./SSARE
      dockerfile: ./nlp_service/Dockerfile
    restart: always
    ports:
      - "${NLP_SERVICE_PORT}:0420"
    networks:
      - app_network
    depends_on:
      - redis
      - postgres_service
      - prefect_server
    environment:
      - PREFECT_API_URL=http://prefect_server:${PREFECT_SERVER_PORT}/api
    develop:
      watch:
        - path: ./SSARE/nlp_service
          target: /app
          action: sync

  pelias_placeholder:
    image: pelias/placeholder
    container_name: pelias_placeholder
    command: >
      sh -c '
        if [ ! -s /data/placeholder/store.sqlite3 ]; then
          echo "Placeholder data not found or empty. Downloading..."
          rm -f /data/placeholder/store.sqlite3
          mkdir -p /data/placeholder
          wget -O /data/placeholder/store.sqlite3.gz https://data.geocode.earth/placeholder/store.sqlite3.gz
          gunzip /data/placeholder/store.sqlite3.gz
        else
          echo "Placeholder data found."
        fi
        ls -l /data/placeholder
        ./cmd/server.sh
      '
    environment:
      - PORT=${PELIAS_PLACEHOLDER_PORT}
    ports:
      - "${PELIAS_PLACEHOLDER_PORT}:${PELIAS_PLACEHOLDER_PORT}"
    volumes:
      - ./data/placeholder:/data/placeholder
    networks:
      - app_network
    depends_on:
        - prefect_server

  postgres_service:
    build: 
      context: ./SSARE
      dockerfile: ./postgres_service/Dockerfile
    ports:
      - "${POSTGRES_SERVICE_PORT}:5434"
    networks:
      - app_network
    depends_on:
      - articles_database
      - prefect_server
    develop:
      watch:
        - path: ./SSARE/postgres_service
          target: /app
          action: sync

  prefect_agent:
    image: prefecthq/prefect:2.16-python3.11-conda
    restart: always
    command: prefect worker start -p default
    environment:
      - PREFECT_API_URL=http://prefect_server:4200/api
    networks:
      - app_network
    depends_on:
      - prefect_server

  prefect_cli:
    image: prefecthq/prefect:2.16-python3.11-conda
    environment:
      - PREFECT_API_URL=http://prefect_server:${PREFECT_SERVER_PORT}/api
    networks:
      - app_network
    depends_on:
      - prefect_server
      - prefect_agent

  prefect_database:
    image: pgvector/pgvector:pg16
    restart: always
    environment:
      - POSTGRES_USER=${PREFECT_DB_USER}
      - POSTGRES_PASSWORD=${PREFECT_DB_PASSWORD}
      - POSTGRES_DB=${PREFECT_DB_NAME}
    volumes:
      - ./SSARE/app:/app
      - ./data/prefect_db/data:/var/lib/postgresql/data
    ports:
      - "${PREFECT_DB_PORT}:5432"
    networks:
      - app_network

  prefect_server:
    image: prefecthq/prefect:2.16-python3.11-conda
    restart: always
    volumes:
      - prefect:/root/.prefect
    entrypoint: ["/opt/prefect/entrypoint.sh", "prefect", "server", "start"]
    environment:
      - PREFECT_UI_URL=http://0.0.0.0:${PREFECT_SERVER_PORT}
      - PREFECT_API_URL=http://0.0.0.0:${PREFECT_SERVER_PORT}/api
      - PREFECT_SERVER_API_HOST=0.0.0.0
      - PREFECT_API_DATABASE_CONNECTION_URL=postgresql+asyncpg://${PREFECT_DB_USER}:${PREFECT_DB_PASSWORD}@prefect_database:5432/${PREFECT_DB_NAME}
    ports:
      - "${PREFECT_SERVER_PORT}:4200"
    depends_on:
      - prefect_database
    networks:
      - app_network
 

  r2r:
    build: 
      context: ./SSARE
      dockerfile: ./r2r_server/Dockerfile
    ports:
      - "${R2R_PORT}:8000"
    environment:
      - POSTGRES_USER=${R2R_DB_USER}
      - POSTGRES_PASSWORD=${R2R_DB_PASSWORD}
      - POSTGRES_HOST=r2r_database
      - POSTGRES_PORT=5432
      - POSTGRES_DBNAME=${R2R_DB_NAME}
      - POSTGRES_VECS_COLLECTION=r2r_vecs_3
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - CONFIG_OPTION=${CONFIG_OPTION:-default}
    depends_on:
      - r2r_database
      - prefect_server
    networks:
      - app_network
    develop:
      watch:
        - path: ./SSARE/r2r_server
          target: /app
          action: sync

  r2r_database:
    image: pgvector/pgvector:pg16
    restart: always
    environment:
      - POSTGRES_USER=${R2R_DB_USER}
      - POSTGRES_PASSWORD=${R2R_DB_PASSWORD}
      - POSTGRES_DB=${R2R_DB_NAME}
    volumes:
      - ./data/r2r_db/data:/var/lib/postgresql/data
    ports:
      - "${R2R_DB_PORT}:5432"
    networks:
      - app_network
    depends_on:
      - prefect_server
      
  rag_service:
    build: 
      context: ./SSARE
      dockerfile: ./rag_service/Dockerfile
    restart: always
    ports:
      - "${RAG_SERVICE_PORT}:4312"
    networks:
      - app_network
    depends_on:
      - redis
      - r2r_database
      - prefect_server
    environment:
      - PREFECT_API_URL=http://prefect_server:${PREFECT_SERVER_PORT}/api
      - POSTGRES_HOST=r2r_database
      - POSTGRES_USER=${R2R_DB_USER}
      - POSTGRES_PASSWORD=${R2R_DB_PASSWORD}
      - POSTGRES_DBNAME=${R2R_DB_NAME}
      - POSTGRES_PORT=5432
      - POSTGRES_VECS_COLLECTION=ssare_vec
      - INIT_DB=true
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - R2R_SERVER_URL=http://r2r:${R2R_PORT}
    env_file:
      - .env
    develop:
      watch:
        - path: ./SSARE/rag_service
          target: /app
          action: sync

  redis:
    image: redis:latest
    command: redis-server /usr/local/etc/redis/redis.conf
    volumes:
      - ./core/configs/redis.conf:/usr/local/etc/redis/redis.conf
    ports:
      - "${REDIS_PORT}:6379"
    networks:
      - app_network
    depends_on:
      - prefect_server

  scraper_service:
    build: 
      context: ./SSARE
      dockerfile: ./scraper_service/Dockerfile
    ports:
      - "${SCRAPER_SERVICE_PORT}:8081"
    environment:
      - PREFECT_API_URL=http://prefect_server:${PREFECT_SERVER_PORT}/api
    networks:
      - app_network
    depends_on:
      - redis
      - prefect_server
    develop:
      watch:
        - path: ./SSARE/scraper_service
          target: /app
          action: sync

networks:
  app_network:
    external: true
  default:
    external: false

volumes:
  postgres_data:
  prefect:
  prefect_db: